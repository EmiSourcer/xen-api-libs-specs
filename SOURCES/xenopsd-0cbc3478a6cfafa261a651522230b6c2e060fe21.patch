From 0cbc3478a6cfafa261a651522230b6c2e060fe21 Mon Sep 17 00:00:00 2001
From: Si Beaumont <simon.beaumont@citrix.com>
Date: Wed, 8 Apr 2015 14:58:44 +0100
Subject: [PATCH] CA-157286: Remove now-unused arguments to PCI.add

Signed-off-by: Si Beaumont <simon.beaumont@citrix.com>
---
 xc/device.ml            | 6 +++---
 xc/device.mli           | 3 +--
 xc/xenops_server_xen.ml | 5 +----
 3 files changed, 5 insertions(+), 9 deletions(-)

diff --git a/xc/device.ml b/xc/device.ml
index 7e7c03e..d57ce7c 100644
--- a/xc/device.ml
+++ b/xc/device.ml
@@ -1013,7 +1013,7 @@ let release_libxl ~msitranslate ~pci_power_mgmt pcidevs domid =
 
 (* XXX: we don't want to use the 'xl' command here because the "interface"
    isn't considered as stable as the C API *)
-let xl_pci cmd ?(msitranslate=0) ?(pci_power_mgmt=0) pcidevs domid =
+let xl_pci cmd pcidevs domid =
 	List.iter
 		(fun dev ->
 			try
@@ -1030,8 +1030,8 @@ let add_xl = xl_pci "pci-attach"
 
 let release_xl = xl_pci "pci-detach"
 
-let add ~xc ~xs ~hvm ~msitranslate ~pci_power_mgmt ?flrscript pcidevs domid devid =
-	try add_xl ~msitranslate ~pci_power_mgmt pcidevs domid
+let add pcidevs domid =
+	try add_xl pcidevs domid
 	with exn -> raise (Cannot_add (pcidevs, exn))
 
 let release ~xc ~xs ~hvm pcidevs domid devid =
diff --git a/xc/device.mli b/xc/device.mli
index 9fc649e..d515f54 100644
--- a/xc/device.mli
+++ b/xc/device.mli
@@ -134,8 +134,7 @@ sig
 
 	exception Cannot_use_pci_with_no_pciback of t list
 
-	val add : xc:Xenctrl.handle -> xs:Xenstore.Xs.xsh -> hvm:bool -> msitranslate:int -> pci_power_mgmt:int
-		-> ?flrscript:string option -> dev list -> Xenctrl.domid -> int -> unit
+	val add : dev list -> Xenctrl.domid -> unit
 	val release : xc:Xenctrl.handle -> xs:Xenstore.Xs.xsh -> hvm:bool
 		-> dev list -> Xenctrl.domid -> int -> unit
 	val reset : xs:Xenstore.Xs.xsh -> dev -> unit
diff --git a/xc/xenops_server_xen.ml b/xc/xenops_server_xen.ml
index 40dfc57..96e02ee 100644
--- a/xc/xenops_server_xen.ml
+++ b/xc/xenops_server_xen.ml
@@ -1584,9 +1584,6 @@ module PCI = struct
 				xs.Xs.write
 					(Printf.sprintf "/local/domain/0/backend/pci/%d/0/power_mgmt" frontend_domid)
 					(if non_persistent.VmExtra.pci_power_mgmt then "1" else "0");
-				(* Apply overrides (if provided) *)
-				let msitranslate = if (Opt.default non_persistent.VmExtra.pci_msitranslate pci.msitranslate) then 1 else 0 in
-				let pci_power_mgmt = if (Opt.default non_persistent.VmExtra.pci_power_mgmt pci.power_mgmt) then 1 else 0 in
 
 				if not (Sys.file_exists "/sys/bus/pci/drivers/pciback") then begin
 					error "PCIBack has not been loaded";
@@ -1594,7 +1591,7 @@ module PCI = struct
 				end;
 
 				Device.PCI.bind [ device ] Device.PCI.Pciback;
-				Device.PCI.add ~xc ~xs ~hvm ~msitranslate ~pci_power_mgmt [ device ] frontend_domid 0
+				Device.PCI.add [ device ] frontend_domid
 			) Newest vm
 
 	let unplug task vm pci =
